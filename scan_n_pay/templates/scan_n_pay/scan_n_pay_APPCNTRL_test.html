{% extends 'scan_n_pay/base_scan_n_pay.html' %}
{% load static %}
{% block title %}Scan Products{% endblock %}
{% block stylesheet %}
<style>
  table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 60%;
  }
  
  td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }
  
  tbody tr:nth-child(even) {
    background-color: #dddddd;
  }
</style>
{% endblock %}
{% block content %}
<div>
  <p class="h5 mt-3">Scan products:</p>
  <div class="d-flex justify-content-between mt-3 mb-5">
    <form>
      <input type='text' id='barcode' value='' placeholder="barcode">
      <input class="button" type="button" id="btn_enter" value="Enter">
      <input class="button ml-5" type="button" id="btn_lookup" value="Search Products">
    </form>
    <a href="#" class="btn btn-sm btn-primary mb-3" role="button">Purchase</a>
  </div>
  <div class='mt-3 mb-5'>
    <p class="h5">Produts to purchase:</p>
    <div id='ItemsContainer'>
      <table id="items_table">
        <thead>
            <tr class="bg-primary">
                <th>Product Name</th>
                <th>Quantity</th>
                <th class='text-center'>Price</th>
            </tr>
        </thead>
        <tbody id="items__list">
        </tbody>
        <tfoot>
            <tr>
                <td><strong></strong></td>
                <td class="text-right"><strong>Total Price:</strong></td>
                <td class="text-right"><strong>0.00</strong></td>
            </tr>
        </tfoot>
      </table>      
    </div>

  </div>

  <div class='mt-5'>
    <hr>
    <div class="mt-1 mb-1">
      <button class="button btn-primary" id="submitBtn">Purchase!</button>
    </div>
    </p>
    <h5>How to test:</h5>
    <ul>
      <li>Test Card #: <span class="text-danger">4242 4242 4242 4242.</span></li>
      <li>Make sure the expiration date is in the future. </li>
      <li>Add any 3 numbers for the CVC and any 5 numbers for the postal code. </li>
      <li>Enter any email address and name.</li>
    </ul>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script src="https://js.stripe.com/v3/"></script>
<script src="{% static 'payments/js/payments.js' %}"></script> 

<script>

// Class to hold basic item data
class Item {
    constructor(id, itemId, description, price, discount=0, discountType=1, quantity=1){
        this.id = id;
        this.itemId = itemId;
        this.description = description;
        this.quantity = quantity;
        this.price = price;         // regular price 
        this.discount = discount;
        this.discountType = 1;       // 1: percentage off regular price; 2: ammount off, e.g., 50 cents
        this.specialDiscount = 0;   // this can manager's account, item damaged discount. etc
        this.discountCalc = 0;      // 
        this.purchasePrice = 0 ;    // this is the price to pay for the item. It is equal to (regular_price - discounts)
        this.comment ='';
    }
}
 
// Class to hold all transaction data
class TransactionData {
    constructor() {
        this.allItems = [];
        this.totals = {
            price: 0,
            quantity: 0 
        }
        this.comment = '';
    }

    addItem(itemId, description, price, discount=0, discountType=1, quantity=1) {
        let id, newItem; 

        // Create new ID
        if (this.allItems.length > 0) {
            id = this.allItems[this.allItems.length - 1].id + 1;
        } else {
            id = 0;
        }

        newItem = new Item(id, itemId, description, price, discount=0, discountType=1, quantity=1); 
        this.allItems.push(newItem);  
        
        return newItem;
    }

    deleteItem(id) {
        // id = 6
        //data.allItems[id];
        // ids = [1 2 4 6 8]
        //index = 3
        
        let ids = this.allItems.map(item => item.id)
        let index = ids.indexOf(id);

        if (index !== -1) {
            this.allItems.splice(index, 1);
        }
    }

    // Reset transactionData to empty (ready for next transaction)
    resetData() {
        this.allItems.splice(0, this.allItems.length);
        this.totals.price = 0;
        this.totals.quantity = 0;
        this.comment = '';
    } 
} 

// Class to hold UI data and methods
class UIController {

    static #DOMstrings = {
        barcodeInput: 'barcode',
        itemsTable: "items_table",
        itemsContainer: 'ItemsContainer',
        itemsList: 'items__list',
    };

    // Add and display the item in the allItems list
    static addListItem(item) {      
        // Create HTML string        
        let html = `<tr id="item-${item.id}">
          <td>${item.description}</td>
          <td>${item.quantity}</td>
          <td class='text-right'>${item.price}</td>
        </tr>`
        console.log(html);
        
        // Insert the HTML into the DOM
        const listRef = document.getElementById(this.#DOMstrings.itemsList);
        const newRow = listRef.insertRow();   // Insert a row at the end of the table
        newRow.innerHTML = html;
    }   
    
    // Delete the select item from UI display
    static deleteListItem(selectorID) {            
        var el = document.getElementById(selectorID);
        el.parentNode.removeChild(el);       
    }
        
    // Reset the barcode input box after a successful scan    
    static clearBarcodeField() {
        let el_barcode = document.getElementById(this.#DOMstrings.barcodeInput);
        el_barcode.value = '';
        el_barcode.focus();
    }

    // To add a column to display special actions for a staff member
    static addStaffColumn() {
        const STAFF_COLUMN = 3;
        const tableRef = document.getElementById(this.#DOMstrings.itemsTable);
        for (let r = 0, n = tableRef.rows.length; r < n; r++) {
            tableRef.rows[r].insertCell(STAFF_COLUMN);
            tableRef.rows[r].cells[STAFF_COLUMN].innerHTML = "&nbsp;&nbsp;";
        }
    }

}

class AppController {
    constructor() {
        this.transData = new TransactionData(); 
    }

    // Get the item info by its barcode
    getItemByCode() {
        const barcode =  document.getElementById('barcode').value;
        if (barcode.length > 0) {
        getItem(barcode);
        }
    }

    // Fetch item info from the server
    async fetchItemInfo(barcode) {
        try {
            const result = await fetch(`get_item/?barcode=${barcode}`);
            const data = await result.json();
            console.log(data);
            if(data.validInd === 1) {
                
                // 1. Add the item data to TransData
                const newItem = transData.addItem(data.itemId, data.description, data.price);
                console.log(newItem);
                console.log(transData);       

                // 2. add the item to UI display
                UIController.addListItem(newItem);
                UIController.addStaffColumn();

                // 3. Reset the barcode input box
                UIController.clearBarcodeField();

            } else {
                console.log("data not valid.")
            }

        } catch(error) {
            console.log(error);
        }
    }

    static seupEventListeners() {
        document.getElementById('btn_enter').addEventListener('click', getItemByCode);

        document.getElementById('barcode').addEventListener('keypress', function(event) {   
            if((event.keyCode === 13) || (event.which === 13)) {
            event.preventDefault();
            getItemByCode();
            // console.log(event.target);
            // console.log(event.target, event.target.parentNode);
            // console.log(event.keyCode);
            }
        })
    }

    // Initialize when a new transaction starts
    init() {
        this.transData.resetData();   // empty all previous data if any.

        seupEventListeners();

    }
}

const app = new AppController();
app.init();


  // Fetch post
  // (async () => {
  //   const rawResponse = await fetch('https://httpbin.org/post', {
  //     method: 'POST',
  //     headers: {
  //       'Accept': 'application/json',
  //       'Content-Type': 'application/json'
  //     },
  //     body: JSON.stringify({a: 1, b: 'Textual content'})
  //   });
  //   const content = await rawResponse.json();

  //   console.log(content);
  // })();
    async function postData() {
    const rawResponse = await fetch('https://httpbin.org/post', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({a: 1, b: 'Textual content'})
    });
    const content = await rawResponse.json();

    console.log(content);
  };

</script>
{% endblock %}