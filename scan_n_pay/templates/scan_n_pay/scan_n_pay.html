{% extends 'scan_n_pay/base_scan_n_pay.html' %}
{% load static %}
{% block title %}Scan Products{% endblock %}
{% block stylesheet %}
<style>
  table {
    font-family: arial, sans-serif;
    border-collapse: collapse;
    width: 60%;
  }
  
  td, th {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
  }
  
  tr:nth-child(even) {
    background-color: #dddddd;
  }
</style>
{% endblock %}
{% block content %}
<div>
  <p class="h5 mt-3">Scan products:</p>
  <div class="d-flex justify-content-between mt-3 mb-5">
    <form class='ml-3'>
      <input type='text' id='barcode' value='' placeholder="barcode">
      <input class="button" type="button" id="btn_enter" value="Enter">
      <input class="button ml-5" type="button" id="btn_lookup" value="Search Products">
    </form>
    <a href="#" class="btn btn-sm btn-primary mb-3" role="button">Purchase</a>
  </div>
  <div class='mt-3 mb-5'>
    <p class="h5">Produts to purchase:</p>
    <div>
      <table>
        <tr>
          <th>Product Name</th>
          <th>Quantity</th>
          <th class='text-center'>Price</th>
        </tr>
        <tr>
          <td>Alfreds Futterkiste</td>
          <td>1</td>
          <td class='text-right'>12.34</td>
        </tr>
        <tr>
          <td>Centro comercial Moctezuma</td>
          <td>1</td>
          <td class='text-right'>23.45</td>
        </tr>
        <tr>
          <td>Ernst Handel</td>
          <td>1</td>
          <td class='text-right'>34.56</td>
        </tr>
        <tr>
          <td>Island Trading</td>
          <td>1</td>
          <td class='text-right'>45.67</td>
        </tr>
        <tr>
          <td>Laughing Bacchus</td>
          <td>1</td>
          <td class='text-right'>13.50</td>
        </tr>
        <tr>
          <td>Magazzini Alimentari Riuniti</td>
          <td>1</td>
          <td class='text-right'>21.34</td>
        </tr>
      </table>      
    </div>

  </div>

  <div class='mt-5'>
    <hr>
    <div class="mt-1 mb-1">
      <button class="button btn-primary" id="submitBtn">Purchase!</button>
    </div>
    </p>
    <h5>How to test:</h5>
    <ul>
      <li>Test Card #: <span class="text-danger">4242 4242 4242 4242.</span></li>
      <li>Make sure the expiration date is in the future. </li>
      <li>Add any 3 numbers for the CVC and any 5 numbers for the postal code. </li>
      <li>Enter any email address and name.</li>
    </ul>
  </div>
</div>
{% endblock %}
{% block javascript %}
<script src="https://js.stripe.com/v3/"></script>
<script src="{% static 'payments/js/payments.js' %}"></script> 

<script>

class Item {
    constructor(id, itemId, description, price, discount=0, discountType=1, quantity=1){
        this.id = id;
        this.itemId = itemId;
        this.description = description;
        this.quantity = quantity;
        this.regularPrice = price;
        this.discount = discount;
        this.discountType = 1;       // 1: percentage off regular price; 2: ammount off, e.g., 50 cents
        this.specialDiscount = 0;   // this can manager's account, item damaged discount. etc
        this.discountCalc = 0;      // 
        this.purchasePrice = 0 ;    // this is the price to pay for the item. It is equal to (regular_price - discounts)
        this.comment ='';
    }
}
 
class TransactionData {
    constructor() {
        this.allItems = [];
        this.totals = {
            price: 0,
            quantity: 0 
        }
        this.comment = '';
    }

    addItem(itemId, description, price, discount=0, discountType=1, quantity=1) {
        let id, newItem; 

        // Create new ID
        if (this.allItems.length > 0) {
            id = this.allItems[this.allItems.length - 1].id + 1;
        } else {
            id = 0;
        }

        newItem = new Item(id, itemId, description, price, discount=0, discountType=1, quantity=1); 
        this.allItems.push(newItem);
    }

    // deleteItem(id) {
    //     const ids; 
    //     const index;
            
    //     // id = 6
    //     //data.allItems[id];
    //     // ids = [1 2 4 6 8]
    //     //index = 3
        
    //     ids = this.allItems.map(item => item.id)

    //     index = ids.indexOf(id);

    //     if (index !== -1) {
    //         this.allItems.splice(index, 1);
    //     }
    // }
} 

const transData = new TransactionData(); 
console.log(transData);

async function getItem(barcode) {
    try {
        const result = await fetch(`get_item/?barcode=${barcode}`);
        const data = await result.json();
        console.log(data);
        //console.log(`${barcode}: ${data.name}`);
        
        transData.addItem(data.itemId, data.description, data.price);

        console.log(transData);

        return data;

    } catch(error) {
        console.log(error);
    }
}

function getItemByCode() {
    const barcode =  document.getElementById('barcode').value;
    if (barcode.length > 0) {
      getItem(barcode);
    }
    document.getElementById('barcode').value = '';
}

document.getElementById('btn_enter').addEventListener('click', getItemByCode);

document.getElementById('barcode').addEventListener('keypress', function(event) {   
    if((event.keyCode === 13) || (event.which === 13)) {
      event.preventDefault();
      getItemByCode();
      // console.log(event.target);
      // console.log(event.target, event.target.parentNode);
      // console.log(event.keyCode);
    }
})

  
  // Fetch post
  // (async () => {
  //   const rawResponse = await fetch('https://httpbin.org/post', {
  //     method: 'POST',
  //     headers: {
  //       'Accept': 'application/json',
  //       'Content-Type': 'application/json'
  //     },
  //     body: JSON.stringify({a: 1, b: 'Textual content'})
  //   });
  //   const content = await rawResponse.json();

  //   console.log(content);
  // })();
    async function postData() {
    const rawResponse = await fetch('https://httpbin.org/post', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({a: 1, b: 'Textual content'})
    });
    const content = await rawResponse.json();

    console.log(content);
  };

</script>
{% endblock %}